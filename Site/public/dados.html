<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.6">
  <title>Monitoramento do Arduino</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="logo-container">
      <img src="favicon.ico" class="logo-site" alt="Logo">
    </div>

    <div class="nuvens-container">
      <div class="coluna">
        <div class="nuvem">
          <p class="titulo">Temperatura</p>
          <span class="valor-sensor" id="temperatura--span"></span>
          <img src="imagens/nuvem.png" class="nuvem-img" alt="Temperatura">
        </div>
        <div class="nuvem">
          <p class="titulo">Gases T√≥xicos</p>
          <span class="valor-sensor" id="gasesToxicos--span"></span>
          <img src="imagens/nuvem.png" class="nuvem-img" alt="Gases T√≥xicos">
        </div>
        <div class="nuvem">
          <p class="titulo">Gases Inflam√°veis</p>
          <span class="valor-sensor" id="gasesInflamaveis--span"></span>
          <img src="imagens/nuvem.png" class="nuvem-img" alt="Gases Inflam√°veis">
        </div>
      </div>
      <div class="coluna">
        <div class="nuvem">
          <p class="titulo">Umidade do Solo</p>
          <span class="valor-sensor" id="umidadeSolo--span"></span>
          <img src="imagens/nuvem.png" class="nuvem-img" alt="Umidade do Solo">
        </div>
        <div class="nuvem">
          <p class="titulo">Umidade do Ar</p>
          <span class="valor-sensor" id="umidadeAr--span"></span>
          <img src="imagens/nuvem.png" class="nuvem-img" alt="Umidade do Ar">
        </div>
        <div class="nuvem">
          <p class="titulo">Est√° Chovendo?</p>
          <span class="valor-sensor" id="chovendo--span"></span>
          <img src="imagens/nuvem.png" class="nuvem-img" alt="Chuva">
        </div>
      </div>
    </div>
  </div>

  <div style="text-align:center; margin-top: 40px;">
    <button onclick="abrirHistorico()" style="padding: 12px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">üìú Ver Hist√≥rico</button>
  </div>

  <div style="text-align:center; margin-top: 20px;">
    <button onclick="voltarParaInicio()" style="padding: 12px 20px; font-size: 16px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">üîô Voltar para In√≠cio</button>
  </div>

  <script>
    let ws;
    let emailUsuario = "";

    window.onload = async function iniciar() {
      try {
        // üîç Buscar dom√≠nio
        const protocoloWS = location.protocol === 'https:' ? 'wss' : 'ws';
        const dominioWebSocket = `${protocoloWS}://${location.host}`;
        ws = new WebSocket(dominioWebSocket);


        const res = await fetch('/usuario-logado');
        const user = await res.json();

        if (user.logado) {
          emailUsuario = user.email;

          // üîå Conex√£o com WebSocket (porta deve bater com o servidor)
          ws = new WebSocket(dominioWebSocket);
          ws.onopen = () => {
            ws.send(JSON.stringify({ email: emailUsuario }));
            console.log("‚úÖ WebSocket conectado");
          };
          ws.onmessage = event => {
            try {
              const leitura = JSON.parse(event.data);
              if (leitura && leitura.temp) atualizarPainel(leitura);
            } catch (e) {
              console.error('‚ùå Dados inv√°lidos recebidos:', event.data);
            }
          };


        } else {
          alert("‚ö†Ô∏è Fa√ßa login para acessar.");
          window.location.href = "/";
        }
      } catch (error) {
        console.error("‚ùå Erro na inicializa√ß√£o:", error.message);
      }
    };

    // üîÅ Fallback via hist√≥rico a cada 5 segundos
    setInterval(async () => {
      try {
        const res = await fetch('/historico');
        const dados = await res.json();
        if (dados.length > 0) atualizarPainel(dados[0]);
      } catch (err) {
        console.error('‚ùå Falha ao buscar hist√≥rico:', err.message);
      }
    }, 5000); // 5 segundos

    function atualizarPainel(leitura) {
      document.getElementById("temperatura--span").textContent = leitura.temp+" ¬∞C";
      document.getElementById("umidadeAr--span").textContent = leitura.umidAr+" %";
      document.getElementById("umidadeSolo--span").textContent = leitura.umidSolo+" %";
      document.getElementById("gasesToxicos--span").textContent = leitura.gasToxico+" %";
      document.getElementById("gasesInflamaveis--span").textContent = leitura.gasInflamavel+" %";
      document.getElementById("chovendo--span").textContent = leitura.estaChovendo ? "üåßÔ∏è Sim" : "‚òÄÔ∏è N√£o";
    }

    function abrirHistorico() {
      window.location.href = "record.html";
    }

    function voltarParaInicio() {
      window.location.href = "index.html";
    }
  </script>
</body>
</html>

